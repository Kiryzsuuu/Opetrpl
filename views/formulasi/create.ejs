<%- include('../partials/page-start', { title }) %>

<div class="d-flex justify-content-between align-items-center mb-4 page-animate">
  <h2><i class="bi bi-plus-circle"></i> Buat Formulasi Baru</h2>
  <a href="/formulasi" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Kembali</a>
</div>

<%- include('../partials/flash') %>

<form action="/formulasi" method="POST" class="card">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Kode</label>
        <input name="kode" class="form-control" required />
      </div>
      <div class="col-md-8">
        <label class="form-label">Nama</label>
        <input name="nama" class="form-control" required />
      </div>

      <div class="col-md-6">
        <label class="form-label">Kategori Produk</label>
        <input name="kategoriProduk" class="form-control" required />
      </div>
      <div class="col-md-6">
        <label class="form-label">Estimasi Waktu Produksi</label>
        <input name="estimasiWaktuProduksi" class="form-control" placeholder="contoh: 2 jam" />
      </div>

      <div class="col-12">
        <label class="form-label">Deskripsi</label>
        <textarea name="deskripsi" class="form-control" rows="3"></textarea>
      </div>

      <div class="col-12">
        <label class="form-label">Cara Produksi</label>
        <textarea name="caraProduksi" class="form-control" rows="4" required></textarea>
      </div>

      <div class="col-md-4">
        <label class="form-label">Target Hasil (Jumlah)</label>
        <input type="number" name="targetHasil[jumlah]" class="form-control" min="0" step="0.01" />
      </div>
      <div class="col-md-4">
        <label class="form-label">Target Hasil (Satuan)</label>
        <input name="targetHasil[satuan]" class="form-control" placeholder="kg / pcs" />
      </div>
      <div class="col-md-4">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <option value="Draft" selected>Draft</option>
          <option value="Disetujui">Disetujui</option>
          <option value="Produksi">Produksi</option>
          <option value="Ditolak">Ditolak</option>
        </select>
      </div>

      <div class="col-12">
        <label class="form-label">Komposisi</label>
        <div class="row g-2 align-items-end">
          <div class="col-md-6">
            <label class="form-label small text-muted">Komoditas</label>
            <select id="komoditasId" class="form-select">
              <option value="">-- pilih komoditas --</option>
              <% (komoditas || []).forEach((k) => { %>
                <option value="<%= k._id %>"><%= k.kode %> - <%= k.nama %></option>
              <% }) %>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">Jumlah</label>
            <input id="komoditasJumlah" type="number" class="form-control" min="0" step="0.01" />
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted">Satuan</label>
            <input id="komoditasSatuan" class="form-control" placeholder="kg" />
          </div>
          <div class="col-12">
            <button type="button" class="btn btn-outline-primary btn-sm" id="btnTambahKomposisi">
              <i class="bi bi-plus"></i> Tambah ke Komposisi
            </button>
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label small text-muted">Komposisi (JSON) - otomatis terisi saat tombol "Tambah" dipakai</label>
          <textarea name="komposisi" id="komposisi" class="form-control" rows="4">[]</textarea>
          <div class="form-text">Format: [{"komoditas":"<id>","jumlah":1,"satuan":"kg"}]</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card-footer d-flex justify-content-end gap-2">
    <a href="/formulasi" class="btn btn-secondary">Batal</a>
    <button class="btn btn-primary" type="submit"><i class="bi bi-save"></i> Simpan</button>
  </div>
</form>

<script>
  (function () {
    const komposisiEl = document.getElementById('komposisi');
    const btn = document.getElementById('btnTambahKomposisi');
    const idEl = document.getElementById('komoditasId');
    const jumlahEl = document.getElementById('komoditasJumlah');
    const satuanEl = document.getElementById('komoditasSatuan');

    function parseJsonArray(text) {
      try {
        const v = JSON.parse(text || '[]');
        return Array.isArray(v) ? v : [];
      } catch {
        return [];
      }
    }

    btn?.addEventListener('click', function () {
      const komoditas = idEl.value;
      const jumlah = Number(jumlahEl.value || 0);
      const satuan = (satuanEl.value || '').trim();
      if (!komoditas || !jumlah) return;

      const arr = parseJsonArray(komposisiEl.value);
      arr.push({ komoditas, jumlah, satuan: satuan || undefined });
      komposisiEl.value = JSON.stringify(arr);

      idEl.value = '';
      jumlahEl.value = '';
      satuanEl.value = '';
    });
  })();
</script>

<%- include('../partials/page-end') %>
