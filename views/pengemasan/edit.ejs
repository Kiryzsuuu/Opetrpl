<%- include('../partials/page-start', { title }) %>

<div class="d-flex justify-content-between align-items-center mb-4 page-animate">
  <h2><i class="bi bi-pencil-square"></i> Edit Pengemasan</h2>
  <div class="d-flex gap-2">
    <a href="/pengemasan/<%= pengemasan._id %>" class="btn btn-outline-primary"><i class="bi bi-eye"></i> Detail</a>
    <a href="/pengemasan" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Kembali</a>
  </div>
</div>

<%- include('../partials/flash') %>

<form action="/pengemasan/<%= pengemasan._id %>?_method=PUT" method="POST" class="card">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-8">
        <label class="form-label">Produksi</label>
        <select name="produksi" class="form-select" required>
          <option value="">-- pilih produksi --</option>
          <% (produksi || []).forEach((p) => { %>
            <option value="<%= p._id %>" <%= pengemasan.produksi && String(pengemasan.produksi._id || pengemasan.produksi) === String(p._id) ? 'selected' : '' %>><%= p.kodeProduksi || '-' %> â€¢ Batch <%= p.batchNumber || '-' %></option>
          <% }) %>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Tanggal Kemas</label>
        <input type="date" name="tanggalKemas" class="form-control" value="<%= pengemasan.tanggalKemas ? new Date(pengemasan.tanggalKemas).toISOString().slice(0,10) : '' %>" required />
      </div>

      <div class="col-md-6">
        <label class="form-label">Jenis Pengemas</label>
        <input name="jenisPengemas" class="form-control" value="<%= pengemasan.jenisPengemas || '' %>" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">Jumlah Kemasan</label>
        <input type="number" name="jumlahKemasan" class="form-control" value="<%= pengemasan.jumlahKemasan ?? '' %>" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">Ukuran Kemasan</label>
        <input name="ukuranKemasan" class="form-control" value="<%= pengemasan.ukuranKemasan || '' %>" />
      </div>

      <div class="col-md-3">
        <label class="form-label">Berat/Kemasan</label>
        <input type="number" step="0.01" name="beratPerKemasan" class="form-control" value="<%= pengemasan.beratPerKemasan ?? '' %>" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Nomor Batch</label>
        <input name="nomorBatch" class="form-control" value="<%= pengemasan.nomorBatch || '' %>" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Tanggal Kadaluarsa</label>
        <input type="date" name="tanggalKadaluarsa" class="form-control" value="<%= pengemasan.tanggalKadaluarsa ? new Date(pengemasan.tanggalKadaluarsa).toISOString().slice(0,10) : '' %>" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <% ['Pending','Selesai','Gagal'].forEach((s) => { %>
            <option value="<%= s %>" <%= (pengemasan.status === s) ? 'selected' : '' %>><%= s %></option>
          <% }) %>
        </select>
      </div>

      <div class="col-md-6">
        <label class="form-label">Standar Keamanan</label>
        <input name="standarKeamanan" class="form-control" value="<%= pengemasan.standarKeamanan || '' %>" />
      </div>

      <div class="col-md-3 form-check mt-4">
        <input class="form-check-input" type="checkbox" id="labelNutrisi" name="labelNutrisi" value="true" <%= pengemasan.labelNutrisi ? 'checked' : '' %> />
        <label class="form-check-label" for="labelNutrisi">Label Nutrisi</label>
      </div>
      <div class="col-md-3 form-check mt-4">
        <input class="form-check-input" type="checkbox" id="labelHalal" name="labelHalal" value="true" <%= pengemasan.labelHalal ? 'checked' : '' %> />
        <label class="form-check-label" for="labelHalal">Label Halal</label>
      </div>

      <div class="col-12">
        <label class="form-label">Sertifikasi Keamanan (JSON)</label>
        <textarea name="sertifikasiKeamanan" class="form-control font-monospace" rows="6" spellcheck="false" autocapitalize="off" autocomplete="off"><%=
          Array.isArray(pengemasan.sertifikasiKeamanan)
            ? (pengemasan.sertifikasiKeamanan.length
              ? JSON.stringify(pengemasan.sertifikasiKeamanan, null, 2)
              : JSON.stringify([{ jenisSertifikat: '', nomorSertifikat: '', tanggalBerlaku: '' }], null, 2))
            : (String(pengemasan.sertifikasiKeamanan || '').trim() || JSON.stringify([{ jenisSertifikat: '', nomorSertifikat: '', tanggalBerlaku: '' }], null, 2))
        %></textarea>
      </div>

      <div class="col-12">
        <label class="form-label">Audit Trail (JSON)</label>
        <textarea name="auditTrail" class="form-control font-monospace" rows="7" spellcheck="false" autocapitalize="off" autocomplete="off"><%=
          Array.isArray(pengemasan.auditTrail)
            ? (pengemasan.auditTrail.length
              ? JSON.stringify(pengemasan.auditTrail, null, 2)
              : JSON.stringify([{ tanggal: '', aktivitas: '', pic: '', hasil: '' }], null, 2))
            : (String(pengemasan.auditTrail || '').trim() || JSON.stringify([{ tanggal: '', aktivitas: '', pic: '', hasil: '' }], null, 2))
        %></textarea>
      </div>

      <div class="col-12"><label class="form-label">Catatan</label><textarea name="catatan" class="form-control" rows="3"><%= pengemasan.catatan || '' %></textarea></div>
    </div>
  </div>
  <div class="card-footer d-flex justify-content-end gap-2">
    <a href="/pengemasan" class="btn btn-secondary">Batal</a>
    <button class="btn btn-primary" type="submit"><i class="bi bi-save"></i> Simpan</button>
  </div>
</form>

<%- include('../partials/page-end') %>
