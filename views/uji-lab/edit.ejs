<%- include('../partials/page-start', { title }) %>

<div class="d-flex justify-content-between align-items-center mb-4 page-animate">
  <h2><i class="bi bi-pencil-square"></i> Edit Uji Laboratorium</h2>
  <div class="d-flex gap-2">
    <a href="/uji-lab/<%= ujiLab._id %>" class="btn btn-outline-primary"><i class="bi bi-eye"></i> Detail</a>
    <a href="/uji-lab" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Kembali</a>
  </div>
</div>

<%- include('../partials/flash') %>

<form action="/uji-lab/<%= ujiLab._id %>?_method=PUT" method="POST" class="card">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-8">
        <label class="form-label">Formulasi</label>
        <select name="formulasi" class="form-select" required>
          <option value="">-- pilih formulasi --</option>
          <% (formulasi || []).forEach((f) => { %>
            <option value="<%= f._id %>" <%= ujiLab.formulasi && String(ujiLab.formulasi._id || ujiLab.formulasi) === String(f._id) ? 'selected' : '' %>><%= f.kode %> - <%= f.nama %></option>
          <% }) %>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Kode Uji</label>
        <input name="kodeUji" class="form-control" value="<%= ujiLab.kodeUji || '' %>" required />
      </div>

      <div class="col-md-4">
        <label class="form-label">Jenis Uji</label>
        <select name="jenisUji" class="form-select" required>
          <% ['Mikrobiologi','Kimia','Fisik','Sensori','Keamanan Pangan'].forEach((j) => { %>
            <option value="<%= j %>" <%= (ujiLab.jenisUji === j) ? 'selected' : '' %>><%= j %></option>
          <% }) %>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Tanggal Uji</label>
        <input type="date" name="tanggalUji" class="form-control" value="<%= ujiLab.tanggalUji ? new Date(ujiLab.tanggalUji).toISOString().slice(0,10) : '' %>" required />
      </div>
      <div class="col-md-4">
        <label class="form-label">Laboratorium</label>
        <input name="laboratorium" class="form-control" value="<%= ujiLab.laboratorium || '' %>" />
      </div>

      <div class="col-md-4">
        <label class="form-label">Hasil Uji</label>
        <select name="hasilUji" class="form-select">
          <% ['Pending','Lulus','Tidak Lulus'].forEach((h) => { %>
            <option value="<%= h %>" <%= (ujiLab.hasilUji === h) ? 'selected' : '' %>><%= h %></option>
          <% }) %>
        </select>
      </div>

      <div class="col-12">
        <label class="form-label">Parameter Uji (JSON)</label>
        <textarea name="parameterUji" class="form-control font-monospace" rows="8" spellcheck="false" autocapitalize="off" autocomplete="off" placeholder='[{"parameter":"TPC","nilai":"1","satuan":"CFU","status":"Lulus"}]'><%=
          Array.isArray(ujiLab.parameterUji)
            ? (ujiLab.parameterUji.length ? JSON.stringify(ujiLab.parameterUji, null, 2) : '')
            : (String(ujiLab.parameterUji || '').trim() || '')
        %></textarea>
        <div class="form-text">Isi sebagai array JSON. Jika tidak ada, kosongkan atau isi <span class="font-monospace">[]</span>. Contoh: <span class="font-monospace">[{"parameter":"TPC","nilai":"1","satuan":"CFU","status":"Lulus"}]</span></div>
      </div>

      <div class="col-12"><label class="form-label">Catatan</label><textarea name="catatan" class="form-control" rows="2"><%= ujiLab.catatan || '' %></textarea></div>
      <div class="col-12"><label class="form-label">Rekomendasi</label><textarea name="rekomendasi" class="form-control" rows="2"><%= ujiLab.rekomendasi || '' %></textarea></div>
    </div>
  </div>

  <div class="card-footer d-flex justify-content-end gap-2">
    <a href="/uji-lab" class="btn btn-secondary">Batal</a>
    <button class="btn btn-primary" type="submit"><i class="bi bi-save"></i> Simpan</button>
  </div>
</form>

<%- include('../partials/page-end') %>
