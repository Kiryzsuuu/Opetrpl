<%- include('../partials/page-start', { title }) %>

<div class="d-flex justify-content-between align-items-center mb-4 page-animate">
  <h2><i class="bi bi-plus-circle"></i> Tambah Uji Laboratorium</h2>
  <a href="/uji-lab" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Kembali</a>
</div>

<%- include('../partials/flash') %>

<form action="/uji-lab" method="POST" class="card">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-8">
        <label class="form-label">Formulasi</label>
        <select name="formulasi" class="form-select" required>
          <option value="">-- pilih formulasi --</option>
          <% (formulasi || []).forEach((f) => { %>
            <option value="<%= f._id %>" <%= (selectedFormulasi && String(selectedFormulasi._id) === String(f._id)) ? 'selected' : '' %>><%= f.kode %> - <%= f.nama %></option>
          <% }) %>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Kode Uji</label>
        <input name="kodeUji" class="form-control" required />
      </div>

      <div class="col-md-4">
        <label class="form-label">Jenis Uji</label>
        <select name="jenisUji" class="form-select" required>
          <% ['Mikrobiologi','Kimia','Fisik','Sensori','Keamanan Pangan'].forEach((j) => { %>
            <option value="<%= j %>"><%= j %></option>
          <% }) %>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Tanggal Uji</label>
        <input type="date" name="tanggalUji" class="form-control" required />
      </div>
      <div class="col-md-4">
        <label class="form-label">Laboratorium</label>
        <input name="laboratorium" class="form-control" />
      </div>

      <div class="col-md-4">
        <label class="form-label">Hasil Uji</label>
        <select name="hasilUji" class="form-select">
          <option value="Pending" selected>Pending</option>
          <option value="Lulus">Lulus</option>
          <option value="Tidak Lulus">Tidak Lulus</option>
        </select>
      </div>

      <div class="col-12">
        <label class="form-label">Parameter Uji</label>
        <input type="hidden" name="parameterUji" id="parameterUjiJson" value="[]" />

        <div class="border rounded p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="text-muted small">Tambah baris parameter uji (parameter, nilai, satuan, status).</div>
            <button type="button" class="btn btn-sm btn-outline-primary" id="parameterAdd">
              <i class="bi bi-plus"></i> Tambah
            </button>
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th style="width: 30%">Parameter</th>
                  <th style="width: 20%">Nilai</th>
                  <th style="width: 20%">Satuan</th>
                  <th style="width: 20%">Status</th>
                  <th style="width: 10%"></th>
                </tr>
              </thead>
              <tbody id="parameterRows"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-12"><label class="form-label">Catatan</label><textarea name="catatan" class="form-control" rows="2"></textarea></div>
      <div class="col-12"><label class="form-label">Rekomendasi</label><textarea name="rekomendasi" class="form-control" rows="2"></textarea></div>
    </div>
  </div>

  <div class="card-footer d-flex justify-content-end gap-2">
    <a href="/uji-lab" class="btn btn-secondary">Batal</a>
    <button class="btn btn-primary" type="submit"><i class="bi bi-save"></i> Simpan</button>
  </div>
</form>

<script>
  (function () {
    function safeTrim(v) {
      return String(v == null ? '' : v).trim();
    }

    function renderRow(item) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="form-control form-control-sm" data-field="parameter" placeholder="Contoh: TPC" /></td>
        <td><input class="form-control form-control-sm" data-field="nilai" placeholder="Contoh: 1" /></td>
        <td><input class="form-control form-control-sm" data-field="satuan" placeholder="Contoh: CFU" /></td>
        <td><input class="form-control form-control-sm" data-field="status" placeholder="Contoh: Lulus" /></td>
        <td class="text-end">
          <button type="button" class="btn btn-sm btn-outline-danger" data-action="remove"><i class="bi bi-trash"></i></button>
        </td>
      `;
      tr.querySelector('[data-field="parameter"]').value = item && item.parameter ? item.parameter : '';
      tr.querySelector('[data-field="nilai"]').value = item && item.nilai ? item.nilai : '';
      tr.querySelector('[data-field="satuan"]').value = item && item.satuan ? item.satuan : '';
      tr.querySelector('[data-field="status"]').value = item && item.status ? item.status : '';
      return tr;
    }

    function collect() {
      const rows = Array.from(document.querySelectorAll('#parameterRows tr'));
      return rows
        .map((tr) => ({
          parameter: safeTrim(tr.querySelector('[data-field="parameter"]').value),
          nilai: safeTrim(tr.querySelector('[data-field="nilai"]').value),
          satuan: safeTrim(tr.querySelector('[data-field="satuan"]').value),
          status: safeTrim(tr.querySelector('[data-field="status"]').value)
        }))
        .filter((it) => it.parameter || it.nilai || it.satuan || it.status);
    }

    function syncHidden() {
      document.getElementById('parameterUjiJson').value = JSON.stringify(collect());
    }

    const rowsEl = document.getElementById('parameterRows');
    rowsEl.appendChild(renderRow({}));

    document.getElementById('parameterAdd').addEventListener('click', function () {
      rowsEl.appendChild(renderRow({}));
      syncHidden();
    });

    document.addEventListener('click', function (e) {
      const btn = e.target.closest && e.target.closest('button[data-action="remove"]');
      if (!btn) return;
      const tr = btn.closest('tr');
      if (tr && tr.parentElement && tr.parentElement.id === 'parameterRows') {
        tr.remove();
        syncHidden();
      }
    });

    document.addEventListener('input', function (e) {
      if (e.target && e.target.closest('#parameterRows')) syncHidden();
    });

    const form = document.querySelector('form[action="/uji-lab"]');
    if (form) form.addEventListener('submit', syncHidden);

    syncHidden();
  })();
</script>

<%- include('../partials/page-end') %>
